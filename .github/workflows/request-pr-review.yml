name: Daily PR Reminder

on:
  schedule:
    - cron: "0 1 * * 1-5" # UTC Í∏∞Ï§Ä 01:00 (ÌïúÍµ≠ ÏãúÍ∞Ñ 10:00)

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get Assigned PRs
        id: get_prs
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const workers = JSON.parse(fs.readFileSync('.github/workflows/reviewers.json'));

            // Î≥∏Ïù∏Ïùò GitHub IDÎ•º Ïó¨Í∏∞Ïóê ÏÑ§Ï†ï
            const MY_GITHUB_ID = 'your-github-id';
            const MY_SLACK_ID = workers[MY_GITHUB_ID];

            // Ìï†ÎãπÎêú PR Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            // ÎÇ¥Í∞Ä Î¶¨Î∑∞Ïñ¥Î°ú Ìï†ÎãπÎêú PR ÌïÑÌÑ∞ÎßÅ
            const assignedPRs = prs.filter(pr => 
              pr.requested_reviewers.some(reviewer => reviewer.login === MY_GITHUB_ID)
            );

            // PR Ï†ïÎ≥¥ Ìè¨Îß∑ÌåÖ
            let message = "üîç *Ïò§ÎäòÏùò Î¶¨Î∑∞Ìï† PR Î™©Î°ù*\n\n";

            if (assignedPRs.length === 0) {
              message += "> ÌòÑÏû¨ Ìï†ÎãπÎêú PRÏù¥ ÏóÜÏäµÎãàÎã§.";
            } else {
              assignedPRs.forEach(pr => {
                const dDayLabel = pr.labels
                  .find(label => label.name.startsWith('D-'))?.name || 'ÎßàÍ∞êÏùº ÎØ∏Ï†ï';
                message += `> ‚Ä¢ <${pr.html_url}|${pr.title}>\n`;
                message += `>   - ÏûëÏÑ±Ïûê: ${pr.user.login}\n`;
                message += `>   - ÎßàÍ∞ê: ${dDayLabel}\n\n`;
              });
            }

            return JSON.stringify({
              slackId: MY_SLACK_ID,
              message: message
            });

      - name: Send Slack Message
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ fromJson(steps.get_prs.outputs.result).slackId }}
          payload: |
            {
              "text": "Daily PR Reminder",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJson(fromJson(steps.get_prs.outputs.result).message) }}
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
